<!DOCTYPE html>
<html lang="en">
<head>

<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dapp</title>
<style>
    .w500 {
        width: 500px;
    }
    .text20 {
        font-size: 20px;
    }

    .colorBlue {
        color: dodgerblue;
    }

    .mt30 {
        margin-top: 30px;
    }

    .excbtn {
        cursor: pointer;
        text-align: center;
        display: inline-block;
        padding: 10px 24px;
        background-color: #90ee90;
        border-radius: 8px;
    }
    
    .grid2col {
        display: grid;
        grid-template-columns: auto auto;
        gap: 20px;
    }

    .flexcol {
        display: flex;
        flex-direction: column;
    }

    .border {
        border: #888888;
        border-radius: 10px;
        padding: 10px;
    }
</style>
<!-- bootstrap css -->
<link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
    integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l"
    crossorigin="anonymous"
>

</head>

<body style="padding: 50px;">

<div>
    <div id="address">address</div>
    <div id="chainId">chain id</div>
</div>

<div class="mt30">
    <input type="file" id="inputAbi">
</div>

<div class="mt30">
    <div id="contractName" class="text20">Contract name</div>
    <div id="contractStatus">no contract</div>
</div>

<div class="mt30">
    <div class="text20">
        <input type="text" id="inputContractAddress" class="w500">
        <div id="btnContractAddress" class="excbtn">at address</div>
        <div id="contractAddress">contract address</div>
    </div>
    <div id="methodContainer" class="grid2col mt30"></div>
</div>


<!-- jquery -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
    integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
    crossorigin="anonymous">
</script>

<!-- bootstrap js -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-Piv4xVNRyMGpqkS2by6br4gNJ7DXjqk09RmUpJ8jgGtD7zP9yug3goQfGII0yAns"
    crossorigin="anonymous">
</script>

<!-- sweet alert 2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- web3 -->
<script src="/static/js/web3.min.js"></script>
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.8.2/web3.min.js"></script> -->

<script></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const web3 = new Web3(Web3.givenProvider);

    window.w3 = web3

    const info = {
        address: 'address',
        chainId: 'chain id',
        reset: () => {
            info.address = 'address'
            info.chainId = 'chain id'
        },
        setAddress: (address) => {
            info.address = address || 'address',
            window.address.innerHTML = info.address
        },
        setChainId: (chainId) => {
            info.chainId = chainId || ''
            window.chainId.innerHTML = `chain id ${info.chainId}`
        }
    }

    window.info3 = info

    const contract = {
        web3: null,
        abi: null,
        address: null,
        name: 'no contract',
        reset: () => {
            contract.web3 = contract.abi = contract.address = contract.name = null
        },
        setName: (name) => {
            contract.name = name || 'no contract'
            window.contractName.innerHTML = contract.name
        },
        loadAbi: (abi) => {
            const container = document.getElementById('methodContainer')

            container.innerHTML = ``
            contract.setName(abi.contractName || 'Contract name')

            if (!abi) {
                contract.abi = null
                contract.loadWeb3()
                return
            }

            contract.abi = abi.abi
            contract.loadWeb3()

            abi.abi.forEach((aConfig) => {
                if (aConfig.type !== 'function') return

                const wraperDiv = document.createElement('div')
                const nameDiv = document.createElement('div')
                const inputWraper = document.createElement('div')
                const inputValue = document.createElement('input')
                const execDiv = document.createElement('div')
                const resultDiv = document.createElement('div')

                const inputNodes = []

                wraperDiv.classList.add('border')

                nameDiv.innerHTML = aConfig.name
                nameDiv.classList.add('colorBlue')

                inputWraper.classList.add('flexcol')

                resultDiv.innerHTML = 'result: '

                aConfig.inputs.forEach(({name, type}, i) => {
                    const paramInput = document.createElement('input')
                    paramInput.placeholder = `${name || `param${i}`} - ${type}`

                    inputWraper.appendChild(paramInput)
                    inputNodes.push(paramInput)
                })

                inputValue.placeholder = `balance to send`

                execDiv.innerHTML = 'exec'
                execDiv.classList.add('excbtn')

                execDiv.addEventListener('click', (e) => {
                    if (!contract.web3) {
                        return alert('no web3 contract')
                    }

                    const noResult = {}

                    const params = inputNodes.map((iNode, i) => {
                        const inputType = aConfig.inputs[i].type
                        const splitCompa = (str) => str.split(',').map(v => v.trim())

                        if (inputType.includes('tuple')) {
                            if (inputType.includes('[]')) {
                                return iNode.value.split('],').map((v) => {
                                    return splitCompa(v.trim().replaceAll(/\[/g, '').replaceAll(/\]/g, ''))
                                })
                            }

                            return splitCompa(iNode.value.trim().replaceAll(/\[/g, '').replaceAll(/\]/g, ''))
                        }

                        if (inputType.includes('bool')) {
                            if (inputType.includes('[]')) {
                                return iNode.value.split(',').map((v) => v.trim() === 'true' || v.trim() === '1')
                            }
                            return iNode.value === 'true' || iNode.value === '1'
                        }

                        if (inputType.includes('[]')) {
                            return splitCompa(iNode.value)
                        }

                        return iNode.value.trim()
                    })

                    console.log(params)

                    const options = {
                        from: web3.eth.defaultAccount,
                    }

                    if (aConfig.stateMutability === 'payable') {
                        options.value = inputValue.value || '0'

                        console.log(options)
                    }

                    let promiseResult = contract.web3.methods[aConfig.name](...params).call({...options})
                    if (aConfig.stateMutability === 'nonpayable' || aConfig.stateMutability === 'payable') {
                        promiseResult = promiseResult.catch((err) => {
                            console.log('call before fail', err)
                        }).then(() => {
                            return contract.web3.methods[aConfig.name](...params).send({...options}).then((r) => {
                                console.log(r)
                                return noResult
                            })
                        })
                    }

                    promiseResult.then((r) => {
                        resultDiv.innerHTML = `result: `

                        console.log('result:', r)
                        if (r === noResult) return alert('transaction success')

                        if (aConfig.outputs.length === 1) {
                            resultDiv.innerHTML = `result: ${r}`
                            if (aConfig.outputs[0].type.includes('[]')) {
                                const data = r.map((d, i) => {
                                    return `index${i}: ${d}`
                                }).join(';<br />')
                                resultDiv.innerHTML = `result: [<br />${data}<br />]`
                            }
                            return
                        }

                        aConfig.outputs.forEach(({name, type}, i) => {
                            const rDiv = document.createElement('div')
                            rDiv.innerHTML = `${name || `param${i}`} = ${r[i]}`

                            if (type.includes('[]')) {
                                rDiv.innerHTML = `[${rDiv.innerHTML}]`
                            }

                            resultDiv.append(rDiv)
                        })
                    }).catch((err) => {
                        console.log(err)
                        alert('transaction fail')
                    })

                })

                container.appendChild(wraperDiv)
                wraperDiv.appendChild(nameDiv)
                wraperDiv.appendChild(inputWraper)

                if (aConfig.stateMutability === 'payable') {
                    wraperDiv.appendChild(inputValue)
                }

                wraperDiv.appendChild(execDiv)
                wraperDiv.appendChild(resultDiv)
            })
        },
        loadAddress: (address) => {
            contract.address = address
            window.contractAddress.innerHTML = address || 'contract address'
            contract.loadWeb3()
        },
        loadWeb3: () => {
            if (!contract.abi || !contract.address) {
                contract.web3 = null
                window.contractStatus.innerHTML = 'no web3'
                return
            }

            contract.web3 = new web3.eth.Contract(contract.abi, contract.address)
            window.contractStatus.innerHTML = 'ready'
        }
    }

    window.c3 = contract

    window.inputAbi.addEventListener('change', (e) => {
        const file = e.target.files[0]

        if (!file) return

        const reader = new FileReader()
        reader.onload = (evt) => {
            contract.loadAbi(JSON.parse(evt.target.result))
        }

        reader.readAsText(file)
    })

    window.btnContractAddress.addEventListener('click', (e) => {
        contract.loadAddress(window.inputContractAddress.value)
    })

    
    const init = () => {
        ethereum.on('accountsChanged', accounts => {
            if (!accounts.length) {
                contract.web3 = null
                return
            }

            web3.eth.getAccounts().then((accs) => {
                web3.eth.defaultAccount = accounts[0]
                info.setAddress(web3.eth.defaultAccount)
                contract.loadWeb3()
            })
        });

        ethereum.on('chainChanged', _chainId => {
            web3.eth.getChainId().then((chainId) => {
                info.setChainId(chainId)
                contract.loadWeb3()
            })
        })

        ethereum.request({ method: 'eth_requestAccounts' }).catch(err => {
            console.log('connect wallet fail:', err)

            window.address.innerHTML = `something wrong when connect wallet`
            contract.web3 = null

            return Promise.reject(err)
        }).then(accs => {
            console.log("connected", accs)

            // account via web3
            return web3.eth.getAccounts()
        }).then(accounts => {
            web3.eth.defaultAccount = accounts[0]
            info.setAddress(web3.eth.defaultAccount)
            return web3.eth.getChainId()
        }).then(chainId => {
            info.setChainId(chainId)
        })
    }

    if (window.ethereum) {
        init()
    } else {
        alert('no metamask extension')
    }

})
</script>

</body>
</html>